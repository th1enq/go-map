let selectedLocation = null;
let searchTimeout = null;
let recommendMap = null; // Initialize as null to avoid undefined
let searchInput;
let suggestionsDiv;

// Function to get the JWT token from localStorage
function getAuthToken() {
    return localStorage.getItem('token');
}

// Function to show loading overlay
function showLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
}

// Function to hide loading overlay
function hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

// Initialize map when document is loaded
function initMap() {
    console.log('Trying to initialize map...');
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('Map container not found');
        return null;
    }
    
    try {
        // Add custom CSS for location items
        if (!document.getElementById('recommend-custom-style')) {
            const style = document.createElement('style');
            style.id = 'recommend-custom-style';
            style.innerHTML = `
                .location-item {
                    display: flex;
                    margin-bottom: 10px;
                    padding: 10px;
                    border-radius: 8px;
                    background-color: #fff;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    transition: all 0.2s ease;
                    cursor: pointer;
                }
                
                .location-item:hover {
                    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                    transform: translateY(-2px);
                }
                
                .location-index {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 28px;
                    height: 28px;
                    border-radius: 50%;
                    background-color: #007AFF;
                    color: white;
                    font-weight: bold;
                    margin-right: 10px;
                    flex-shrink: 0;
                }
                
                .location-details {
                    flex: 1;
                }
                
                .location-details h5 {
                    margin-top: 0;
                    margin-bottom: 5px;
                    font-size: 15px;
                    color: #333;
                }
                
                .coordinates {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 5px;
                }
                
                .distance-badge {
                    display: inline-block;
                    background-color: #007AFF;
                    color: white;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-top: 5px;
                }
                
                .no-results {
                    padding: 20px;
                    text-align: center;
                    color: #666;
                    font-style: italic;
                }
                
                /* Pulse animation for current location */
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.3); opacity: 0.7; }
                    100% { transform: scale(1); opacity: 1; }
                }
                
                .current-location-marker div {
                    animation: pulse 2s infinite;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Check if map is already initialized on this container
        if (mapContainer._leaflet_id) {
            console.log('Map already initialized, using existing instance');
            
            // The _leaflet field may not be reliable, so we'll create a new one if needed
            let existingMap = null;
            try {
                existingMap = L.DomUtil.get('map')._leaflet;
            } catch (e) {
                console.log('Could not get existing map:', e);
            }
            
            if (existingMap) {
                return existingMap;
            } else {
                // Remove _leaflet_id to allow re-initialization
                delete mapContainer._leaflet_id;
            }
        }
        
        console.log('Initializing new map');
        // Initialize new map
        const newMap = L.map('map').setView([10.762622, 106.660172], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(newMap);
        
        return newMap;
    } catch (error) {
        console.error('Error initializing map:', error);
        return null;
    }
}

// Initialize map and attach listeners when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize location search elements
    searchInput = document.getElementById('location-search');
    suggestionsDiv = document.getElementById('search-suggestions');
    
    if (!searchInput || !suggestionsDiv) {
        console.error('Search input or suggestions container not found');
    } else {
        // Set up search input event listeners
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 3) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await response.json();
                    
                    suggestionsDiv.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(place => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.textContent = place.display_name;
                            div.onclick = () => {
                                selectedLocation = {
                                    lat: parseFloat(place.lat),
                                    lng: parseFloat(place.lon),
                                    name: place.display_name
                                };
                                searchInput.value = place.display_name;
                                suggestionsDiv.style.display = 'none';
                                if (recommendMap) {
                                    recommendMap.setView([selectedLocation.lat, selectedLocation.lng], 14);
                                    
                                    // Create a custom marker icon for selected location
                                    const selectedLocationIcon = L.divIcon({
                                        className: 'selected-location-marker',
                                        html: '<div style="background-color: #007AFF; width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                                        iconSize: [22, 22],
                                        iconAnchor: [11, 11]
                                    });
                                    
                                    // Remove existing selected location marker if any
                                    if (window.selectedLocationMarker) {
                                        recommendMap.removeLayer(window.selectedLocationMarker);
                                    }
                                    
                                    // Add new marker
                                    window.selectedLocationMarker = L.marker([selectedLocation.lat, selectedLocation.lng], { 
                                        icon: selectedLocationIcon
                                    })
                                    .addTo(recommendMap)
                                    .bindPopup(selectedLocation.name)
                                    .openPopup();
                                }
                            };
                            suggestionsDiv.appendChild(div);
                        });
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    suggestionsDiv.style.display = 'none';
                }
            }, 300);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    // Initialize the map
    recommendMap = initMap();
    
    // Set global map variables
    if (recommendMap) {
        // Update mapFunctions to use this map
        window.mapFunctions = window.mapFunctions || {};
        window.mapFunctions.searchMap = recommendMap;
        
        // Add event listeners for buttons
        const currentLocationBtn = document.getElementById('current-location-button');
        if (currentLocationBtn) {
            currentLocationBtn.addEventListener('click', getCurrentLocation);
        }
        
        // Add event listener for search button
        const searchBtn = document.getElementById('search-button');
        if (searchBtn) {
            searchBtn.addEventListener('click', recommendMostPopular);
        }
        
        // Add event listener for similar trajectories button
        const similarTrajectoriesBtn = document.getElementById('similar-trajectories-button');
        if (similarTrajectoriesBtn) {
            similarTrajectoriesBtn.addEventListener('click', recommendBySimilarTrajectories);
        }
        
        // Set up map click handler
        recommendMap.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (window.mapFunctions?.clearCurrentRoute) {
                window.mapFunctions.clearCurrentRoute();
            }
            
            // Create a custom marker icon for selected location
            const selectedLocationIcon = L.divIcon({
                className: 'selected-location-marker',
                html: '<div style="background-color: #007AFF; width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });
            
            // Remove existing selected location marker if any
            if (window.selectedLocationMarker) {
                recommendMap.removeLayer(window.selectedLocationMarker);
            }
            
            // Add temporary marker while we wait for geocoding
            window.selectedLocationMarker = L.marker([lat, lng], { 
                icon: selectedLocationIcon
            })
            .addTo(recommendMap)
            .bindPopup("Äang tÃ¬m thÃ´ng tin Äá»a Äiá»m...")
            .openPopup();
            
            // Reverse geocode using Nominatim
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    selectedLocation = {
                        lat: lat,
                        lng: lng,
                        name: data.display_name
                    };
                    if (searchInput) {
                        searchInput.value = data.display_name;
                    }
                    
                    // Update marker popup with location name
                    if (window.selectedLocationMarker) {
                        window.selectedLocationMarker.setPopupContent(data.display_name || 'Vá» trÃ­ ÄÃ£ chá»n');
                    }
                })
                .catch(error => {
                    console.error('Error reverse geocoding:', error);
                    selectedLocation = {
                        lat: lat,
                        lng: lng,
                        name: `Vá» trÃ­ (${lat.toFixed(6)}, ${lng.toFixed(6)})`
                    };
                    if (searchInput) {
                        searchInput.value = selectedLocation.name;
                    }
                    
                    // Update marker popup with fallback location name
                    if (window.selectedLocationMarker) {
                        window.selectedLocationMarker.setPopupContent(selectedLocation.name || 'Vá» trÃ­ ÄÃ£ chá»n');
                    }
                });
        });
    } else {
        console.error('Failed to initialize map');
    }
});

// Get current location
function getCurrentLocation() {
    if (!recommendMap) {
        console.error('Map not initialized yet');
        alert('Báº£n Äá» chÆ°a ÄÆ°á»£c khá»i táº¡o. Vui lÃ²ng thá»­ láº¡i sau.');
        return;
    }
    
    if (navigator.geolocation) {
        showLoading();
        if (window.mapFunctions?.clearCurrentRoute) {
            window.mapFunctions.clearCurrentRoute();
        }
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Create a red marker icon for current location
                const currentLocationIcon = L.divIcon({
                    className: 'current-location-marker',
                    html: '<div style="background-color: #007AFF; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>',
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                });
                
                // Remove existing current location marker if any
                if (window.currentLocationMarker) {
                    recommendMap.removeLayer(window.currentLocationMarker);
                }
                
                // Add new current location marker with a pulsing effect
                window.currentLocationMarker = L.marker([lat, lng], { 
                    icon: currentLocationIcon,
                    zIndexOffset: 1000 // Make sure it appears above other markers
                })
                .addTo(recommendMap)
                .bindPopup('Vá» trÃ­ hiá»n táº¡i cá»§a báº¡n')
                .openPopup();
                
                // Reverse geocode using Nominatim
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                    .then(response => response.json())
                    .then(data => {
                        selectedLocation = {
                            lat: lat,
                            lng: lng,
                            name: data.display_name
                        };
                        searchInput.value = data.display_name;
                        recommendMap.setView([lat, lng], 15); // Zoom closer
                        
                        // Add a proper selected location marker
                        const selectedLocationIcon = L.divIcon({
                            className: 'selected-location-marker',
                            html: '<div style="background-color: #007AFF; width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        });
                        
                        if (window.selectedLocationMarker) {
                            recommendMap.removeLayer(window.selectedLocationMarker);
                        }
                        
                        window.selectedLocationMarker = L.marker([lat, lng], { 
                            icon: selectedLocationIcon
                        })
                        .addTo(recommendMap)
                        .bindPopup(data.display_name || 'Vá» trÃ­ ÄÃ£ chá»n')
                        .openPopup();
                        
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error reverse geocoding:', error);
                        selectedLocation = {
                            lat: lat,
                            lng: lng,
                            name: `Vá» trÃ­ (${lat.toFixed(6)}, ${lng.toFixed(6)})`
                        };
                        searchInput.value = selectedLocation.name;
                        recommendMap.setView([lat, lng], 15);
                        
                        // Still add a marker even if geocoding fails
                        const selectedLocationIcon = L.divIcon({
                            className: 'selected-location-marker',
                            html: '<div style="background-color: #007AFF; width: 22px; height: 22px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        });
                        
                        if (window.selectedLocationMarker) {
                            recommendMap.removeLayer(window.selectedLocationMarker);
                        }
                        
                        window.selectedLocationMarker = L.marker([lat, lng], { 
                            icon: selectedLocationIcon
                        })
                        .addTo(recommendMap)
                        .bindPopup(selectedLocation.name || 'Vá» trÃ­ ÄÃ£ chá»n')
                        .openPopup();
                        
                        hideLoading();
                    });
            },
            function(error) {
                hideLoading();
                alert("Lá»i khi láº¥y vá» trÃ­ hiá»n táº¡i: " + error.message);
            },
            { 
                enableHighAccuracy: true, // Cá» gáº¯ng láº¥y vá» trÃ­ GPS chÃ­nh xÃ¡c nháº¥t
                timeout: 10000, // Thá»i gian tá»i Äa chá» Äá»£i (10 giÃ¢y)
                maximumAge: 0 // KhÃ´ng sá»­ dá»¥ng vá» trÃ­ ÄÃ£ lÆ°u trong cache
            }
        );
    } else {
        alert("TrÃ¬nh duyá»t cá»§a báº¡n khÃ´ng há» trá»£ Äá»nh vá».");
    }
}

async function recommendMostPopular() {
    if (!recommendMap) {
        console.error('Map not initialized yet');
        alert('Báº£n Äá» chÆ°a ÄÆ°á»£c khá»i táº¡o. Vui lÃ²ng thá»­ láº¡i sau.');
        return;
    }
    
    if (!selectedLocation) {
        alert("Vui lÃ²ng chá»n má»t vá» trÃ­ trÆ°á»c");
        return;
    }

    // Get auth token
    const token = getAuthToken();
    if (!token) {
        // Redirect to login page if not authenticated
        window.location.href = '/login';
        return;
    }

    // Look for either "search-results" or "results" element
    const resultsDiv = document.getElementById("results");
    if (!resultsDiv) {
        console.error("Results container not found");
        alert("KhÃ´ng tÃ¬m tháº¥y khung hiá»n thá» káº¿t quáº£. Vui lÃ²ng kiá»m tra cáº¥u trÃºc HTML.");
        return;
    }
    resultsDiv.innerHTML = "";

    try {
        showLoading();
        
        // Clear previous search markers but keep current and selected location markers
        if (window.searchMarkers && window.searchMarkers.length > 0) {
            window.searchMarkers.forEach(marker => {
                recommendMap.removeLayer(marker);
            });
        }
        window.searchMarkers = [];
        
        // Clear current route if there is one
        if (window.currentRoute) {
            recommendMap.removeLayer(window.currentRoute);
            window.currentRoute = null;
        }
        
        let response;
        // Add Authorization header with JWT token
        response = await fetch(`/api/location/rcm/hot?lat=${selectedLocation.lat}&lng=${selectedLocation.lng}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        // Check if response is unauthorized
        if (response.status === 401) {
            hideLoading();
            alert('PhiÃªn ÄÄng nháº­p ÄÃ£ háº¿t háº¡n. Vui lÃ²ng ÄÄng nháº­p láº¡i.');
            window.location.href = '/login';
            return;
        }
        
        const locations = await response.json();

        if (locations.error) {
            hideLoading();
            alert(locations.error);
            return;
        }

        // Calculate distance for each location and sort by distance
        const calculateDistanceFunc = window.mapFunctions?.calculateDistance || function(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; // Distance in km
        };
        
        const locationsWithDistance = locations.map(location => {
            const distance = calculateDistanceFunc(
                selectedLocation.lat, 
                selectedLocation.lng, 
                location.latitude, 
                location.longitude
            );
            return {
                ...location,
                distance: distance
            };
        }).sort((a, b) => a.distance - b.distance);

        if (locationsWithDistance.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">KhÃ´ng tÃ¬m tháº¥y Äá»a Äiá»m nÃ o</div>';
            hideLoading();
            return;
        }

        // Store markers in the global array
        window.searchMarkers = [];
        
        // Create a custom pin style icon for search results
        const createPoiIcon = (index) => {
            const colors = ['#FF9500', '#34C759', '#5856D6', '#FF2D55', '#AF52DE', '#007AFF'];
            const color = colors[index % colors.length];
            
            return L.divIcon({
                className: 'poi-marker',
                html: `
                    <div style="background-color: white; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                        <div style="background-color: ${color}; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${index + 1}</div>
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        };
        
        locationsWithDistance.forEach((location, index) => {
            const marker = L.marker([location.latitude, location.longitude], {
                icon: createPoiIcon(index)
            })
            .addTo(recommendMap)
            .bindPopup(`
                <div style="max-width: 250px;">
                    <strong style="font-size: 14px;">${location.name}</strong><br>
                    ${location.category ? `<span style="color: #666;"><strong>Loáº¡i:</strong> ${location.category}</span><br>` : ''}
                    ${location.tag ? `<span style="color: #666;"><strong>Thá» loáº¡i:</strong> ${location.tag}</span><br>` : ''}
                    ${location.activities ? `<span style="color: #666;"><strong>Hoáº¡t Äá»ng:</strong> ${location.activities.join(', ')}</span><br>` : ''}
                    <span style="color: #007AFF; font-weight: bold; font-size: 13px;">Khoáº£ng cÃ¡ch: ${(location.distance * 1000).toFixed(0)}m</span>
                </div>
            `);
            
            window.searchMarkers.push(marker);

            const resultItem = document.createElement("div");
            resultItem.className = "location-item";
            resultItem.innerHTML = `
                <div class="location-index">${index + 1}</div>
                <div class="location-details">
                    <h5>${location.name}</h5>
                    <p class="coordinates">GPS: ${location.latitude.toFixed(5)}, ${location.longitude.toFixed(5)}</p>
                    ${location.category ? `<p class="mb-1"><small><strong>Loáº¡i:</strong> ${location.category}</small></p>` : ''}
                    ${location.tag ? `<p class="mb-1"><small><strong>Thá» loáº¡i:</strong> ${location.tag}</small></p>` : ''}
                    ${location.activities ? `<p class="mb-1"><small><strong>Hoáº¡t Äá»ng:</strong> ${location.activities.join(', ')}</small></p>` : ''}
                    <div class="distance-badge">${(location.distance * 1000).toFixed(0)}m</div>
                </div>
            `;
            resultItem.onclick = () => {
                // Keep the current location centered and zoom in
                recommendMap.setView([selectedLocation.lat, selectedLocation.lng], 16);
                marker.openPopup();
                
                // Draw route from current location to selected point
                if (selectedLocation) {
                    // XÃ³a tuyáº¿n ÄÆ°á»ng cÅ© náº¿u cÃ³, nhÆ°ng giá»¯ nguyÃªn marker
                    if (window.currentRoute) {
                        recommendMap.removeLayer(window.currentRoute);
                        window.currentRoute = null;
                    }
                    
                    // Äáº£m báº£o marker vá» trÃ­ hiá»n táº¡i vÃ  vá» trÃ­ ÄÃ£ chá»n váº«n hiá»n thá»
                    if (window.currentLocationMarker && !recommendMap.hasLayer(window.currentLocationMarker)) {
                        window.currentLocationMarker.addTo(recommendMap);
                    }
                    
                    if (window.selectedLocationMarker && !recommendMap.hasLayer(window.selectedLocationMarker)) {
                        window.selectedLocationMarker.addTo(recommendMap);
                    }
                    
                    // Hiá»n thá» thÃ´ng bÃ¡o Äang tÃ­nh toÃ¡n
                    const loadingPopup = L.popup()
                        .setLatLng([selectedLocation.lat, selectedLocation.lng])
                        .setContent(`
                            <div style="text-align: center; padding: 5px;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span style="margin-left: 5px;">Äang tÃ­nh toÃ¡n lá» trÃ¬nh...</span>
                            </div>
                        `)
                        .openOn(recommendMap);
                    
                    // Láº¥y lá» trÃ¬nh tá»« OSRM API
                    fetch(`https://router.project-osrm.org/route/v1/driving/${selectedLocation.lng},${selectedLocation.lat};${location.longitude},${location.latitude}?overview=full&geometries=geojson`)
                        .then(response => response.json())
                        .then(data => {
                            // ÄÃ³ng popup táº£i
                            recommendMap.closePopup(loadingPopup);
                            
                            if (data.routes && data.routes.length > 0) {
                                const route = data.routes[0];
                                
                                // Chuyá»n Äá»i tá»a Äá» tá»« GeoJSON (kinh Äá», vÄ© Äá») sang Leaflet (vÄ© Äá», kinh Äá»)
                                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                                
                                // Váº½ tuyáº¿n ÄÆ°á»ng vá»i kiá»u má»i
                                window.currentRoute = L.polyline(routeCoordinates, {
                                    color: '#007AFF',
                                    weight: 5,
                                    opacity: 0.8,
                                    dashArray: '10, 10',
                                    lineCap: 'round',
                                    lineJoin: 'round'
                                }).addTo(recommendMap);
                                
                                // TÃ­nh toÃ¡n thÃ´ng tin tuyáº¿n ÄÆ°á»ng
                                const distance = (route.distance / 1000).toFixed(2); // Chuyá»n Äá»i sang km vá»i 2 sá» tháº­p phÃ¢n
                                const duration = Math.round(route.duration / 60); // Chuyá»n Äá»i sang phÃºt
                                
                                // Hiá»n thá» thÃ´ng tin tuyáº¿n ÄÆ°á»ng
                                L.popup()
                                    .setLatLng([selectedLocation.lat, selectedLocation.lng])
                                    .setContent(`
                                        <div style="font-family: Arial, sans-serif; max-width: 200px;">
                                            <strong style="color: #007AFF;">ThÃ´ng tin lá» trÃ¬nh:</strong><br>
                                            <strong>Khoáº£ng cÃ¡ch:</strong> ${distance} km<br>
                                            <strong>Thá»i gian lÃ¡i xe:</strong> ${duration} phÃºt<br>
                                            <small>(ÄÃ¢y lÃ  tuyáº¿n ÄÆ°á»ng lÃ¡i xe ngáº¯n nháº¥t)</small>
                                        </div>
                                    `)
                                    .openOn(recommendMap);
                                
                                // Äiá»u chá»nh tá»· lá» báº£n Äá» Äá» vá»«a hiá»n thá» tuyáº¿n ÄÆ°á»ng vÃ  bao gá»m cáº£ marker
                                const bounds = L.latLngBounds([
                                    [selectedLocation.lat, selectedLocation.lng],
                                    [location.latitude, location.longitude],
                                    ...routeCoordinates
                                ]);
                                
                                // PhÃ³ng to vá»«a Äá»§ Äá» tháº¥y tuyáº¿n ÄÆ°á»ng
                                recommendMap.fitBounds(bounds, { 
                                    padding: [50, 50],
                                    maxZoom: 16 // Giá»i háº¡n má»©c zoom tá»i Äa
                                });
                            } else {
                                // Náº¿u khÃ´ng tÃ¬m tháº¥y tuyáº¿n ÄÆ°á»ng, váº½ ÄÆ°á»ng tháº³ng ÄÆ¡n giáº£n
                                window.currentRoute = L.polyline([
                                    [selectedLocation.lat, selectedLocation.lng],
                                    [location.latitude, location.longitude]
                                ], {
                                    color: '#007AFF',
                                    weight: 5,
                                    opacity: 0.8,
                                    dashArray: '10, 10',
                                    lineCap: 'round',
                                    lineJoin: 'round'
                                }).addTo(recommendMap);
                                
                                // TÃ­nh khoáº£ng cÃ¡ch ÄÆ°á»ng chim bay
                                const airDistance = (location.distance * 1000).toFixed(0);
                                
                                // Hiá»n thá» thÃ´ng bÃ¡o khÃ´ng tÃ¬m tháº¥y tuyáº¿n ÄÆ°á»ng
                                L.popup()
                                    .setLatLng([selectedLocation.lat, selectedLocation.lng])
                                    .setContent(`
                                        <div style="font-family: Arial, sans-serif; max-width: 200px;">
                                            <strong style="color: #007AFF;">KhÃ´ng tÃ¬m tháº¥y tuyáº¿n ÄÆ°á»ng!</strong><br>
                                            <strong>Khoáº£ng cÃ¡ch ÄÆ°á»ng chim bay:</strong> ${airDistance} m<br>
                                            <small>(ÄÃ¢y lÃ  khoáº£ng cÃ¡ch trá»±c tiáº¿p giá»¯a hai Äiá»m)</small>
                                        </div>
                                    `)
                                    .openOn(recommendMap);
                            }
                        })
                        .catch(error => {
                            console.error('Lá»i khi tÃ­nh toÃ¡n tuyáº¿n ÄÆ°á»ng:', error);
                            
                            // ÄÃ³ng popup táº£i
                            recommendMap.closePopup(loadingPopup);
                            
                            // Váº½ ÄÆ°á»ng tháº³ng ÄÆ¡n giáº£n náº¿u cÃ³ lá»i
                            window.currentRoute = L.polyline([
                                [selectedLocation.lat, selectedLocation.lng],
                                [location.latitude, location.longitude]
                            ], {
                                color: '#007AFF',
                                weight: 5,
                                opacity: 0.8,
                                dashArray: '10, 10',
                                lineCap: 'round',
                                lineJoin: 'round'
                            }).addTo(recommendMap);
                            
                            // TÃ­nh khoáº£ng cÃ¡ch ÄÆ°á»ng chim bay
                            const airDistance = (location.distance * 1000).toFixed(0);
                            
                            // Hiá»n thá» thÃ´ng bÃ¡o lá»i
                            L.popup()
                                .setLatLng([selectedLocation.lat, selectedLocation.lng])
                                .setContent(`
                                    <div style="font-family: Arial, sans-serif; max-width: 200px;">
                                        <strong style="color: #007AFF;">Lá»i khi tÃ­nh toÃ¡n tuyáº¿n ÄÆ°á»ng!</strong><br>
                                        <strong>Khoáº£ng cÃ¡ch ÄÆ°á»ng chim bay:</strong> ${airDistance} m<br>
                                        <small>(ÄÃ¢y lÃ  khoáº£ng cÃ¡ch trá»±c tiáº¿p giá»¯a hai Äiá»m)</small>
                                    </div>
                                `)
                                .openOn(recommendMap);
                        });
                }
            };
            resultsDiv.appendChild(resultItem);
        });

        if (locationsWithDistance.length > 0) {
            // Create bounds that include both the selected location and all result locations
            const points = [
                [selectedLocation.lat, selectedLocation.lng],
                ...locationsWithDistance.map(loc => [loc.latitude, loc.longitude])
            ];
            const bounds = L.latLngBounds(points);
            recommendMap.fitBounds(bounds, { padding: [50, 50] });
        }
        hideLoading();
    } catch (error) {
        console.error("Error fetching locations:", error);
        hideLoading();
        alert("ÄÃ£ xáº£y ra lá»i khi tÃ¬m kiáº¿m Äá»a Äiá»m.");
    }
}

// Function to save user location and get recommendations from users with similar trajectories
async function recommendBySimilarTrajectories() {
    console.log('Recommending based on similar trajectories');
    
    showLoading();
    
    // Use the existing map instance instead of creating a new one
    if (!recommendMap) {
        console.error('Map not initialized yet');
        alert('Báº£n Äá» chÆ°a ÄÆ°á»£c khá»i táº¡o. Vui lÃ²ng thá»­ láº¡i sau.');
        hideLoading();
        return;
    }
    
    // Clear existing markers
    if (window.searchMarkers) {
        window.searchMarkers.forEach(marker => recommendMap.removeLayer(marker));
    }
    
    if (window.currentLocationMarker) {
        recommendMap.removeLayer(window.currentLocationMarker);
    }
    
    if (window.selectedLocationMarker) {
        recommendMap.removeLayer(window.selectedLocationMarker);
    }
    
    if (window.currentRoute) {
        recommendMap.removeLayer(window.currentRoute);
    }
    
    window.searchMarkers = [];
    
    try {
        // Máº£ng mÃ u cho cÃ¡c markers
        const colors = ['#34C759', '#5856D6', '#AF52DE', '#FF2D55', '#FF9500', '#007AFF'];
        
        // HÃ m táº¡o biá»u tÆ°á»£ng POI tÃ¹y chá»nh
        const createPoiIcon = (index) => {
            const color = colors[index % colors.length];
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; color: white; font-weight: bold; font-size: 14px;">${index + 1}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        };
        
        // Sá»­ dá»¥ng vá» trÃ­ hiá»n táº¡i náº¿u cÃ³
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Äáº·t marker vá» trÃ­ hiá»n táº¡i
                    window.currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'location-marker',
                            html: '<div class="current-location-dot"></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(recommendMap);
                    
                    // Trung tÃ¢m báº£n Äá» vÃ o vá» trÃ­ hiá»n táº¡i
                    recommendMap.setView([lat, lng], 20);
                    
                    // Láº¥y cÃ¡c Äá»a Äiá»m gáº§n vá» trÃ­ hiá»n táº¡i
                    const response = await fetch('/api/location/rcm/same/4', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch recommendations');
                    }
                    
                    const data = await response.json();
                    console.log('Recommendation data:', data);
                    
                    // Hiá»n thá» káº¿t quáº£
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML = '';
                    
                    // Handle data whether it's an array directly or has a locations property
                    const locations = Array.isArray(data) ? data : (data.locations || []);
                    
                    if (!locations || locations.length === 0) {
                        resultsDiv.innerHTML = '<div class="no-results">KhÃ´ng tÃ¬m tháº¥y gá»£i Ã½ nÃ o. HÃ£y thá»­ Äá»i vá» trÃ­ hoáº·c tiÃªu chÃ­ khÃ¡c.</div>';
                        hideLoading();
                        return;
                    }
                    
                    // ThÃªm má»t Äá»i tÆ°á»£ng Äá» lÆ°u trá»¯ vá» trÃ­ ÄÃ£ chá»n (sáº½ dÃ¹ng sau)
                    selectedLocation = { lat, lng };
                    window.selectedLocation = { lat, lng };
                    
                    // Thiáº¿t láº­p marker cho vá» trÃ­ ÄÃ£ chá»n (Äiá»m báº¯t Äáº§u)
                    window.selectedLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'selected-location-marker',
                            html: '<div class="pulse"></div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(recommendMap)
                    .bindPopup('<div style="text-align: center;"><strong style="color: #007AFF;">Vá» trÃ­ hiá»n táº¡i</strong><br><small>Äiá»m báº¯t Äáº§u</small></div>');
                    
                    // TÃ­nh khoáº£ng cÃ¡ch tá»« vá» trÃ­ hiá»n táº¡i Äáº¿n cÃ¡c Äiá»m gá»£i Ã½
                    const locationsWithDistance = locations.map(location => {
                        const distance = getDistance(lat, lng, location.latitude, location.longitude);
                        return { ...location, distance };
                    });
                    
                    // Sáº¯p xáº¿p káº¿t quáº£ theo khoáº£ng cÃ¡ch tÄng dáº§n
                    locationsWithDistance.sort((a, b) => a.distance - b.distance);
                    
                    // Hiá»n thá» cÃ¡c káº¿t quáº£
                    locationsWithDistance.forEach((location, index) => {
                        const marker = L.marker([location.latitude, location.longitude], {
                            icon: createPoiIcon(index)
                        })
                        .addTo(recommendMap)
                        .bindPopup(`
                            <div style="max-width: 250px;">
                                <strong style="font-size: 14px;">${location.name}</strong><br>
                                ${location.category ? `<span style="color: #666;"><strong>Loáº¡i:</strong> ${location.category}</span><br>` : ''}
                                ${location.tag ? `<span style="color: #666;"><strong>Thá» loáº¡i:</strong> ${location.tag}</span><br>` : ''}
                                ${location.activities ? `<span style="color: #666;"><strong>Hoáº¡t Äá»ng:</strong> ${location.activities.join(', ')}</span><br>` : ''}
                                <span style="color: #34C759; font-weight: bold; font-size: 13px;">Khoáº£ng cÃ¡ch: ${(location.distance * 1000).toFixed(0)}m</span>
                            </div>
                        `);
                        
                        window.searchMarkers.push(marker);

                        const resultItem = document.createElement("div");
                        resultItem.className = "location-item";
                        resultItem.innerHTML = `
                            <div class="location-index" style="background-color: ${colors[index % colors.length]}">${index + 1}</div>
                            <div class="location-details">
                                <h5>${location.name}</h5>
                                <p class="coordinates">GPS: ${location.latitude.toFixed(5)}, ${location.longitude.toFixed(5)}</p>
                                ${location.category ? `<p class="mb-1"><small><strong>Loáº¡i:</strong> ${location.category}</small></p>` : ''}
                                ${location.tag ? `<p class="mb-1"><small><strong>Thá» loáº¡i:</strong> ${location.tag}</small></p>` : ''}
                                ${location.activities ? `<p class="mb-1"><small><strong>Hoáº¡t Äá»ng:</strong> ${location.activities.join(', ')}</small></p>` : ''}
                                <div class="distance-badge" style="background-color: #34C759;">${(location.distance * 1000).toFixed(0)}m</div>
                            </div>
                        `;
                        resultsDiv.appendChild(resultItem);
                    });

                    if (locationsWithDistance.length > 0) {
                        // Create bounds that include both the selected location and all result locations
                        const points = [
                            [lat, lng], // Use direct lat, lng values instead of selectedLocation
                            ...locationsWithDistance.map(loc => [loc.latitude, loc.longitude])
                        ];
                        const bounds = L.latLngBounds(points);
                        recommendMap.fitBounds(bounds, { padding: [50, 50] });
                    }
                    
                    hideLoading();
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    hideLoading();
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML = '<div class="no-results">KhÃ´ng thá» láº¥y vá» trÃ­ hiá»n táº¡i. Vui lÃ²ng cho phÃ©p truy cáº­p vá» trÃ­ vÃ  thá»­ láº¡i.</div>';
                }
            );
        } else {
            hideLoading();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="no-results">TrÃ¬nh duyá»t cá»§a báº¡n khÃ´ng há» trá»£ geolocation.</div>';
        }
    } catch (error) {
        console.error("Error fetching suggestions:", error);
        hideLoading();
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="no-results">ÄÃ£ xáº£y ra lá»i khi táº£i Äá» xuáº¥t.</div>';
    }
}

// Helper function to calculate distance between two coordinates
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the earth in km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c; // Distance in km
}

function deg2rad(deg) {
    return deg * (Math.PI/180);
}

// Export functions for use in other files
window.searchFunctions = {
    showLoading,
    hideLoading,
    getCurrentLocation,
    recommendMostPopular,
    recommendBySimilarTrajectories
};